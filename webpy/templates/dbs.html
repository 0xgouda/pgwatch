<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pgwatch2 :: DBs to monitor</title>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
</head>
<body style="margin: 15px">

<div class="container-fluid">

{% if message %}
<div class="alert alert-warning alert-dismissible" role="alert">
  <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
  {{message}}
</div>
{% endif %}
<h2>Databases under monitoring</h2>
<div class="table-responsive">
    <table class="table table-striped">
        <thead>
            <tr>
                <td>Id</td>
                <td title="NB! Choose a good name as this shouldn't be changed later (cannot easily update InfluxDB data)">Unique name</td>
                <td>DB host</td>
                <td>DB port</td>
                <td>DB dbname</td>
                <td>DB user</td>
                <td title="NB! Password is stored in plain-text in the database">DB password</td>
                <td title="No data will be gathered if SSL connection cannot be established">SSL only?</td>
                <td title="Preset config OR custom config needs to be specified">Preset config</td>
                <td title='{"metric":interval_seconds,...}'>Custom config</td>
                <td>Last modified</td>
                <td>Enabled?</td>
                <td></td>
                <td></td>
            </tr>
        </thead>
        <tbody>
            {% for row in data: %}
            <tr>
                <form action="/dbs" method="post">
                    <td>{{row['md_id']}}<input type="hidden" name="md_id" value="{{row['md_id']}}"></td>
                    <td>{{row['md_unique_name']|e}}</td>
                    <td><input type="text" name="md_hostname" value="{{row['md_hostname']|e}}"></td>
                    <td><input type="text" name="md_port" value="{{row['md_port']|e}}" size="5"></td>
                    <td><input type="text" name="md_dbname" value="{{row['md_dbname']|e}}" size="15"></td>
                    <td><input type="text" name="md_user" value="{{row['md_user']|e}}" size="15"></td>
                    <td><input type="text" name="md_password" value="***" size="15"></td>
                    <td><input type="checkbox" name="md_ssl_only" {% if row['md_ssl_only'] %}checked{% endif %}></td>
                    <td>
                        <select name="md_preset_config_name"> <!-- TODO click with JSON -->
                            <option value="" title="Empty. 'Custom config' must be filled" ></option>
                            {% for pc in preset_configs %}
                            <option value="{{pc['pc_name']|e}}" {% if pc['pc_name'] == row['md_preset_config_name'] %}selected{% endif %}>{{pc['pc_name']|e}}</option>
                            {% endfor %}
                        </select>
                        <a href="/metrics" title="Show preset configs and metric definitions in a new window" target="_blank">show</a>&nbsp;|&nbsp;
                        <a class="copy_to_custom" href="" title="Copy JSON to 'Custom config' for editing">copy</a>
                    </td>
                    <td title='{"metric":interval,...}'><textarea name="md_config" cols="20">{% if row['md_config'] %} {{row['md_config']}} {% endif %}</textarea></td>
                    <td>{{row['md_last_modified_on']}}</td>
                    <td><input type="checkbox" name="md_is_enabled" {% if row['md_is_enabled'] %}checked{% endif %}></td>
                    <td><input type="submit" class="save" name="save" value="Save"></td>
                    <td><input type="submit" name="delete" value="Delete"></td>
                </form>
            </tr>
            {% endfor %}
            <tr>
                <form action="/dbs" method="post">
                    <td></td>
                    <td><input type="text" name="md_unique_name" value="" size="10" title="NB! Choose a good name as this shouldn't be changed later (cannot easily update InfluxDB data)"></td>
                    <td><input type="text" name="md_hostname" value=""></td>
                    <td><input type="text" name="md_port" value="5432" size="5"></td>
                    <td><input type="text" name="md_dbname" value="" size="15"></td>
                    <td><input type="text" name="md_user" value="" size="15"></td>
                    <td><input type="text" name="md_password" value="" size="15"></td>
                    <td><input type="checkbox" name="md_ssl_only"></td>
                    <td>
                        <select name="md_preset_config_name"> <!-- TODO click with JSON -->
                            <option value="" title="Empty. 'Custom config' must be filled" ></option>
                            {% for pc in preset_configs %}
                            <option value="{{pc['pc_name']|e}}">{{pc['pc_name']|e}}</option>
                            {% endfor %}
                        </select>
                        <a href="/preset_configs" title="Show JSON config in a new window" target="_blank">show</a>&nbsp;|&nbsp;
                        <a class="copy_to_custom" href="" title="Copy JSON to 'Custom config' for editing">copy</a>
                    </td>
                    <td title='{"metric":interval,...}'><textarea name="md_config" value="" cols="20"></textarea></td>
                    <td></td>
                    <td><input type="checkbox" name="md_is_enabled" checked></td>
                    <td><input type="submit" class="new" name="new" value="New"></td>
                    <td></td>
                </form>
            </tr>
        </tbody>
    </table>
</div>

    <h2>Active metrics listing</h2>
    <ul>
    {% for m in metrics_list: %}
        <li style="display: inline"><b>{{m['m_name']}}</b> [ver: {{m['versions']}}]</li>
    {% endfor %}

    </ul>
</div>
<!-- TODO check for only preset or custom config -->

<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script>
    var preset_configs = {{preset_configs_json}};

    $(document).ready(function(){
        $(".copy_to_custom").click(function(event){
            event.preventDefault();

            var preset_config_json = preset_configs[$(this).parent().find("[name='md_preset_config_name']").val()];
            // alert(preset_config_json);
            $(this).parent().parent().find("[name='md_config']").val(preset_config_json);

            return false;
        });

        $(".save").add('.new').click(function(event){
            var custom_config = $(this).parent().parent().find("[name='md_config']").val();
            var preset_config = $(this).parent().parent().find("[name='md_preset_config_name']").val();
            if (custom_config > '' && preset_config > '') {
                alert('Preset OR custom config needs to be specifief!');
                return false;
            }
        });
    });
</script>
</body>
</html>
